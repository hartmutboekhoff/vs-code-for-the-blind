<html>
  <head>
    <style>
      table {
        width: 100%;
      }
      thead {
        height: 2em;
      }
      tr:nth-child(2n+1) td {
        border-top: 3px solid blue;
      }
      tr.fail td {
        background-color: #fcc;
      }
      tr.valid td {
        background-color: #cfc;
      }
      tr.hidden {
        display:none;
      }
      td {
        vertical-align: top;
      }
      th {
        border-radius: 1em;
        border: 1px solid black;
      }
      th:first-child {
        border: none;
      }
      th.dragover {
        background-color: #99f;
      }
    </style>
    <script src="../../src/json-schema-matcher.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

    <script id="data">
      let data = {
        first: 'hallo',
        second: ['1',2,3,4.4,5,undefined],
        third: 56
      };
    </script>
    <script id="schema">
      let schema = {
        type:'object',
        properties: {
          first: {
            type: 'string',
            enum: ['a','b','hallo']
          },
          second: {
            type: 'array',
            items: {
              type: ['integer','number','null']
            },
            prefixItems: [
              {type:'string'}
            ]
          },
          third: {
            type: ['integer', 'string'],
            maxLength: 4,
            minimum: 5,
          }
        },
        required: ['second']
      };
    </script>
    <script id="display">
      function toJsonString(o) {
        try {
          return JSON.stringify(o,undefined,2);
        }
        catch(e) {
          return 'ERROR: ' + e;
        }
      }
      function buildMatchRow(ix, m) {
        const rows = [document.createElement('tr'),document.createElement('tr')];
        rows[1].className = 'hidden ';
        rows[0].className = m.valid? 'valid' : 'fail';
        rows[0].innerHTML = '<td>'+ix+'</td>'
                            + '<td>'+m.schemaPath.paths.join('<br/>')+'</td>'
                            + '<td>'+m.jsonPath+'</td>';
        rows[1].innerHTML = '<td/><td><pre class="prettyprint">'+toJsonString(m.schema)+'</pre></td>'
                            + '<td><pre class="prettyprint">'+toJsonString(m.data)+'</pre></td>';
        return rows;
      }
      function displayMatches(matches) {
        const lastRow = document.getElementById('last-row');
        for( let i = 0 ; i < matches.length ; i++ ) {
          lastRow.before(...buildMatchRow(i,matches[i]));
        }
      }
      function clearTable() {
        const tbody = document.getElementById('match-body');
        for( let i = tbody.children.length - 2 ; i >= 0 ; i-- )
          tbody.children[i].remove();
      }
      function startMatching() {
        const jsm = new JsonSchemaMatcher(schema,data); 
        console.log('displaying results', jsm.matches);
        displayMatches(jsm.matches.sort((a,b)=>a.jsonPath.localeCompare(b.jsonPath)));
      }
    </script>
    <script id="startup">
      window.addEventListener('load',()=>{
        startMatching();
      });
      window.addEventListener('click',ev=>{
        console.log(ev.target);
        if( ev.target.tagName == 'TD' && ev.target.previousElementSibling == undefined ) {
          if( ev.target.innerHTML == '' )
            ev.target.parentElement.classList.toggle('hidden');
          else
            ev.target.parentElement.nextElementSibling?.classList.toggle('hidden');
          
        }
        
      });
    </script>
    <script id="drag-drop">
      function dropDataIsValid(ev) {
        return ev.dataTransfer.items.length == 1 
               && ev.dataTransfer.items[0].kind == 'file'
               && ev.dataTransfer.items[0].type == 'application/json';
      }
    	function loadJsonData(f) {
        var reader = new FileReader();
      	reader.onload = function(evt) {
        	data = JSON.parse(evt.target.result);
        	startMatching();
      	};
      	reader.readAsText(f);
    	}      
    	function loadJsonSchema(f) {
        var reader = new FileReader();
      	reader.onload = function(evt) {
        	schema = JSON.parse(evt.target.result);
        	startMatching();
      	};
      	reader.readAsText(f);
    	}      
      
      window.addEventListener('dragover',ev=>{
        const dropTarget = ev.target.closest('[data-drop-target]');
        if( dropDataIsValid(ev) ) {
          ev.preventDefault();
          dropTarget.classList.add('dragover');
          ev.dataTransfer.dropEffect = 'copy';
          return true;
        }
        ev.dataTransfer.dropEffect = 'none';
        return false;
      });
      window.addEventListener('dragleave',ev=>{
        const dropTarget = ev.target.closest('[data-drop-target]');
        dropTarget.classList.remove('dragover');
      });
      window.addEventListener('dragend',ev=>{
        const dropTarget = ev.target.closest('[data-drop-target]');
        dropTarget.classList.remove('dragover');
      })
      window.addEventListener('drop',ev=>{
        const dropTarget = ev.target.closest('[data-drop-target]');
        dropTarget.classList.remove('dragover');
        if( dropDataIsValid(ev) ) {
          clearTable();
          if( dropTarget.dataset.dropTarget == 'data' )
            loadJsonData(ev.dataTransfer.files[0]);
          else if( dropTarget.dataset.dropTarget == 'schema' )
            loadJsonSchema(ev.dataTransfer.files[0]);
        }
        ev.preventDefault();
        //ev.stopPropagation();
      });    
    </script>
  </head>
  <body>
    <table>
      <caption>Schema Object Matches</caption>
      <thead>
        <tr>
          <th>#</th>
          <th data-drop-target="schema"><h2>Schema</h2><p>drop schema-file here</p></p></th>
          <th data-drop-target="data"><h2>Object</h2><p>drop data-file here</p></p></th>
        </tr>
      </thead>
      <tbody id="match-body">
        <tr id="last-row"><td colspan="3">-- Ende --</td></tr>
      </tbody>
    </table>
  </body>
  
</html>